---
user_pods:
  - name: traefik
    image: public.ecr.aws/docker/library/traefik:3.5.3
    network: host
    env:
      BUNNY_API_KEY: "{{ lookup('ripplefcl.bwscache.secret', 'bunny_api').value }}"
      BUNNY_POLLING_TIMEOUT: "600"
      BUNNY_POLLING_INTERVAL: "5"
      BUNNY_TTL: "3600"
      CF_API_EMAIL: "{{ lookup('ripplefcl.bwscache.secret', 'will_email').value }}"
      CF_API_KEY: "{{ lookup('ripplefcl.bwscache.secret', 'cf_token').value }}"
    volume:
      - "/etc/localtime:/etc/localtime:ro"
      - "/opt/pods/traefik/config/traefik.yml:/traefik.yml:ro"
      - "/opt/pods/traefik/config/providers:/providers:ro"
      - "/opt/pods/traefik/config/certs:/certs:ro"
      - "/opt/pods/traefik/config/acme.json:/acme.json"

  - name: plex
    image: ghcr.io/home-operations/plex:1.42.2
    publish:
      - "32400:32400"
    env:
      PLEX_ADVERTISE_URL: "{{ 'https://' + lookup('ripplefcl.bwscache.secret', 'plex_domain').value }}"
      PLEX_CLAIM_TOKEN: "{{ lookup('ripplefcl.bwscache.secret', 'plex_claim_token').value }}"
    volume:
      - "/opt/pods/plex/config:/config"
      - "/opt/shares/pods/media:/media"
      - "/opt/shares/pods/plex:/backup"
    device:
      - "/dev/dri:/dev/dri"
    user: "{{ ansible_facts.user_uid }}:{{ ansible_facts.user_gid }}"
    quadlet_options:
      - "UserNS=keep-id"
      - |
        [Unit]
        RequiresMountsFor=/opt/shares/pods
        BindsTo=opt-shares-pods.mount
        After=opt-shares-pods.mount

  - name: openspeedtest
    image: docker.io/openspeedtest/latest:v2.0.6
    publish:
      - "27031:3000"
      - "27032:3001"
    state: absent

system_pods:
  - name: gravity
    hostname: "{{ inventory_hostname }}"
    image: ghcr.io/beryju/gravity:007613bad35f68afea28c40b2644e2fb09d75860
    network: host
    capabilities:
      - NET_ADMIN
      - NET_RAW
    env:
      LOG_LEVEL: info,dhcp=debug
    volume:
      - "/opt/pods/gravity/config:/config"
      - "/opt/pods/gravity/data:/data"
