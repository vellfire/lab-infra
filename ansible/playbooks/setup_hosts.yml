---
- name: Run host setup tasks
  hosts: linux
  gather_facts: true
  tasks:
    # Added due to a series of unfortunate events
    - name: Verify remote hostname matches inventory
      ansible.builtin.assert:
        that:
          - inventory_hostname == ansible_hostname
        fail_msg: "Expected '{{ inventory_hostname }}' but got '{{ ansible_hostname }}'. Skipping this host."
        quiet: true
      failed_when: false
      register: hostname_check

    - name: End play for hosts with hostname mismatch
      ansible.builtin.meta: end_host
      when: hostname_check.failed | default(false)

- name: Run host setup tasks
  hosts: linux
  gather_facts: true
  module_defaults:
    community.docker.docker_container:
      default_host_ip: ""
      restart_policy: unless-stopped
      state: started
      comparisons:
        '*': strict
        env: allow_more_present
      security_opts:
        - "no-new-privileges:true"
      env:
        TZ: "Europe/London"
  tasks:
    - name: Update hosts
      ansible.builtin.include_role:
        name: update_hosts
        apply:
          become: true
          tags:
            - update
      tags:
        - update

    - name: Get service facts
      ansible.builtin.service_facts:
      tags:
        - setup
        - alloy
        - docker
        - virt

    - name: Run standard setup tasks
      when: ansible_os_family == 'Debian'
      ansible.builtin.include_role:
        name: setup_host
        apply:
          become: true
          tags:
            - setup
            - all
      tags:
        - setup
        - all

    - name: Setup NTP
      when: req_ntp | default(false)
      tags: ["time"]
      ansible.builtin.include_role:
        name: geerlingguy.ntp
        apply:
          become: true
          tags:
            - time
      vars:
        ntp_enabled: true
        ntp_timezone: "Europe/London"
        ntp_manage_config: true
        ntp_servers:
          - "10.10.0.1"

    - name: Setup Alloy monitoring
      when: req_monitor | default(false)
      tags:
        - alloy
      block:
        - name: Install and configure Alloy
          ansible.builtin.include_role:
            name: grafana.grafana.alloy
            apply:
              become: true
          vars:
            alloy_env_file_vars:
              CUSTOM_ARGS: "--disable-reporting"

        - name: Install smartctl exporter
          when: "'physical_hosts' in group_names"
          ansible.builtin.include_role:
            name: prometheus.prometheus.smartctl_exporter
            apply:
              become: true

    - name: Setup NUT client
      when: req_nut | default(false)
      tags:
        - nut
      block:
        - name: Lookup NUT secret
          ansible.builtin.set_fact:
            nut_client_password: "{{ lookup('ripplefcl.bwscache.secret', 'nut_pass').value }}"
          no_log: true

        - name: Install NUT client
          ansible.builtin.include_role:
            name: geerlingguy.nut_client
            apply:
              become: true
              tags:
                - nut
              no_log: true

    - name: Setup podman pods
      when: req_podman | default(false)
      ansible.builtin.include_role:
        name: podman
        apply:
          become: false
          tags:
            - podman
            - pods
      tags:
        - podman
        - pods

    - name: Setup docker
      when: req_docker | default(false)
      ansible.builtin.include_role:
        name: geerlingguy.docker
        apply:
          become: true
          tags:
            - docker
      tags:
        - docker

    - name: Setup pods
      when: pods is defined and req_docker | default(false)
      ansible.builtin.include_role:
        name: setup_pods
        apply:
          become: false
          tags:
            - docker
            - pods
      tags:
        - docker
        - pods
